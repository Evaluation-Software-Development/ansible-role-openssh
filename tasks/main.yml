---
# tasks file for openssh
- name: install openssh
  package:
    name: "{{ openssh_packages }}"
    state: "{{ openssh_package_state }}"
  register: openssh_install_openssh
  until: openssh_install_openssh
  retries: 3

- name: configure selinux to allow openssh_port
  seport:
    ports: "{{ openssh_port }}"
    proto: "tcp"
    setype: "ssh_port_t"
    state: "present"
  when:
    - ansible_selinux.status is defined
    - ansible_selinux.status == "enabled"

- name: generate host key
  command: "/usr/bin/ssh-keygen -q -t {{ item }} -f /etc/ssh/ssh_host_{{ item }}_key -C '' -N ''"
  args:
    creates: "/etc/ssh/ssh_host_{{ item }}_key"
  with_items:
    - "{{ openssh_key_types }}"

- name: make run directory
  file:
    path: "{{ openssh_run_directory }}"
    state: directory

- name: configure openssh
  template:
    dest: "{{ openssh_configuration_file }}"
    src: "{{ lookup('first_found', templates) }}"
    mode: "{{ openssh_template_mode }}"
    owner: root
    group: root
    validate: sshd -f %s -t
  vars:
    templates:
      - "templates/ssh_config_{{ ansible_distribution ~ '-' ~ ansible_distribution_major_version }}.j2"
      - "templates/ssh_config_{{ ansible_distribution }}.j2"
  notify:
    - restart openssh

- name: switch to openssh_port
  set_fact:
    ansible_port: "{{ openssh_port }}"

- name: start and enable openssh
  service:
    name: "{{ openssh_service }}"
    state: started
    enabled: yes
  when:
    - ansible_virtualization_type != "docker" or openssh_ignore_docker
